import{_ as i,c as a,a as n,o as l}from"./app-CO77B8re.js";const e={};function t(h,s){return l(),a("div",null,s[0]||(s[0]=[n(`<h3 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备"><span>环境准备</span></a></h3><p>实验环境：centOS7.6、k8s1.30</p><p>建议：生产环境中，建议使用小版本大于5的Kubernetes版本，比如1.30.5以后的才可用于生产环境。</p><h4 id="节点规划" tabindex="-1"><a class="header-anchor" href="#节点规划"><span>节点规划：</span></a></h4><p>3台master节点+两台node节点</p><p>修改网卡信息：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改网卡信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vi</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/sysconfig/network-scripts/ifcfg-ens33</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改网卡信息（以master01为例）</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">TYPE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Ethernet</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">PROXY_METHOD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">none</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">BROWSER_ONLY</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">no</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">BOOTPROTO</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">static</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 修改为static</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DEFROUTE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">yes</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">IPV4_FAILURE_FATAL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">no</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">IPV6INIT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">no</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 禁用IPV6</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IPV6_AUTOCONF=&quot;yes&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IPV6_DEFROUTE=&quot;yes&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IPV6_FAILURE_FATAL=&quot;no&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IPV6_ADDR_GEN_MODE=&quot;stable-privacy&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">NAME</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ens33</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UUID</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">09d91c45-c45a-4f53-a0d4-183a370427e2</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DEVICE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ens33</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ONBOOT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">yes</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 新增静态IP参数</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">IPADDR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.1.11</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 设置静态 IP 地址</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">NETMASK</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">255.255.255.0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 子网掩码</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">GATEWAY</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.1.1</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 网关地址</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DNS1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.1.1</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 主 DNS</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DNS2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">8.8.8.8</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 备用 DNS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改完成重启网卡</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看网卡配置信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> addr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> show</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ens33</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>节点信息：</p><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>配置</th></tr></thead><tbody><tr><td>k8s-master01 ~ 03</td><td>192.168.1.11~13</td><td>Master/Worker节点</td><td>2C2G 40G</td></tr><tr><td>k8s-node01 ~ 02</td><td>192.168.1.21~22</td><td>Worker节点</td><td>2C2G 40G</td></tr><tr><td>k8s-master-lb</td><td>192.168.1.30</td><td>VIP</td><td>VIP不占用机器</td></tr></tbody></table><p>组件版本信息：</p><table><thead><tr><th>信息</th><th>备注</th></tr></thead><tbody><tr><td>系统版本</td><td>CentOS 7.6</td></tr><tr><td>Docker版本</td><td>20.10.x</td></tr><tr><td>K8s版本</td><td>1.30.x</td></tr><tr><td>Pod网段</td><td></td></tr><tr><td>Service网段</td><td></td></tr></tbody></table><h3 id="基础配置" tabindex="-1"><a class="header-anchor" href="#基础配置"><span>基础配置</span></a></h3><p>主机信息，服务器IP地址不能设置成dhcp，要配置成静态IP。</p><p><strong>修改host</strong>:</p><p>所有节点配置hosts，修改/etc/hosts追加信息如下：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># sudo vi /etc/hosts</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">192.168.1.11</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master01</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 2C2G 40G</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">192.168.1.12</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 2C2G 40G</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">192.168.1.13</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 2C2G 40G</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">192.168.1.30</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master-lb</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # VIP 虚IP不占用机器资源 如果不是高可用集群，该IP为Master01的IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">192.168.1.21</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node01</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 2C2G 40G</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">192.168.1.22</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node02</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 2C2G 40G</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>VIP（虚拟IP）不要和公司内网IP重复，首先去ping一下，不通才可用。VIP需要和主机在同一个局域网内！公有云的话，VIP为公有云的负载均衡的IP，比如阿里云的SLB地址，腾讯云的ELB地址，注意公有云的负载均衡都是内网的负载均衡。</p><p><strong>配置yum源：</strong></p><p>所有节点配置yum源：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 使用 curl 命令从阿里云镜像站下载 CentOS-7 的 Yum 仓库配置文件，并将其保存到 /etc/yum.repos.d/ 目录下，覆盖或替换原有的 CentOS-Base.repo 文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/yum.repos.d/CentOS-Base.repo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://mirrors.aliyun.com/repo/Centos-7.repo</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 自动安装三个软件包，为后续安装 Docker 做准备</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> yum-utils</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> device-mapper-persistent-data</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lvm2</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 添加 Docker 的官方仓库（通过阿里云镜像站加速）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum-config-manager</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --add-repo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改 CentOS-Base.repo 文件，删除包含 mirrors.cloud.aliyuncs.com 和 mirrors.aliyuncs.com 的行</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/mirrors.cloud.aliyuncs.com/d</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/mirrors.aliyuncs.com/d</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/yum.repos.d/CentOS-Base.repo</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>安装必备工具：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jq</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> psmisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> net-tools</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> telnet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> yum-utils</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> device-mapper-persistent-data</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lvm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> git</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>关闭防火墙等服务：</strong></p><p>所有节点关闭防火墙、selinux、dnsmasq、swap：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> disable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> firewalld</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> disable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dnsmasq</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> disable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> NetworkManager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setenforce</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#SELINUX=enforcing#SELINUX=disabled#g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/sysconfig/selinux</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#SELINUX=enforcing#SELINUX=disabled#g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/selinux/config</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">swapoff</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sysctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -w</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vm.swappiness=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ri</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/^[^#]*swap/s@^@#@</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/fstab</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>同步节点间的时钟：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 安装ntpdate</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rpm</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ivh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ntpdate</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看是否已安装</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> list</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> installed</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ntpdate</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点同步时间。时间同步配置如下：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ln</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -sf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/share/zoneinfo/Asia/Shanghai</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/localtime</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Asia/Shanghai</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/timezone</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ntpdate</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> time2.aliyun.com</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 加入到crontab</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">crontab</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 添加以下内容</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">/5 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> /usr/sbin/ntpdate time2.aliyun.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点配置limit：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">ulimit</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -SHn</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 65535</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vim /etc/security/limits.conf</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 末尾添加如下内容</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> soft nofile 655360</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> hard nofile 131072</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> soft nproc 655350</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> hard nproc 655350</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> soft memlock unlimited</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> hard memlock unlimited</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，密钥配置如下：</p><p>说明：阿里云或者AWS上需要单独一台kubectl服务器。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ssh-keygen</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rsa</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Master01配置免密码登录其他节点</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node02</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">do</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ssh-copy-id -i .ssh/id_rsa.pub </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所有节点安装基本工具</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jq</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> psmisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> net-tools</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> yum-utils</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> device-mapper-persistent-data</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lvm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> git</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Master01下载安装文件在作者的github上</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/dotbalo/k8s-ha-install.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#CentOS7需要升级系统</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --exclude=kernel</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内核升级" tabindex="-1"><a class="header-anchor" href="#内核升级"><span>内核升级</span></a></h3><p>所有节点内核至4.19：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查询当前系统内核 Linux k8s-master01 3.10.0-957.el7.x86_64 #1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">uname</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 内核升级 在master01节点下载内核</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 传送安装文件到其他节点</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node02</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">do</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> scp kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$i</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:/root/ </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 所有节点安装内核</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> localinstall</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kernel-ml</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查询所有可用内核</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">awk</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -F\\&#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/menuentry / {print $2}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /boot/grub2/grub.cfg</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 设置默认启动项为 4.19 内核</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> grubby</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --set-default=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 检查默认内核是不是4.19</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grubby</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --default-kernel</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 所有节点重启，然后检查内核是不是4.19</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">reboot</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">uname</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点安装ipvsadm：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 所有节点安装ipvsadm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ipvsadm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ipset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sysstat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> conntrack</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> libseccomp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点配置ipvs模块</p><p>在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack，4.18以下使用nf_conntrack_ipv4即可</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 加载相应的模块</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ip_vs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ip_vs_rr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ip_vs_wrr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ip_vs_sh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nf_conntrack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vim /etc/modules-load.d/ipvs.conf</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 加入以下内容</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_lc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_wlc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_rr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_wrr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_lblc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_lblcr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_dh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_sh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_fo</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_nq</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_sed</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_ftp</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_vs_sh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">nf_conntrack</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_tables</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip_set</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">xt_set</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ipt_set</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ipt_rpfilter</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ipt_REJECT</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ipip</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重启服务</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> systemd-modules-load.service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 检查是否加载</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lsmod</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ip_vs</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nf_conntrack</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>开启一些k8s集群中必须的内核参数：</strong></p><p><strong>所有节点配置k8s内核：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.ip_forward = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fs.may_detach_mounts = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vm.overcommit_memory=1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vm.panic_on_oom=0</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fs.inotify.max_user_watches=89100</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fs.file-max=52706963</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fs.nr_open=52706963</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.netfilter.nf_conntrack_max=2310720</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_keepalive_time = 600</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_keepalive_probes = 3</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_keepalive_intvl =15</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_max_tw_buckets = 36000</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_tw_reuse = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_max_orphans = 327680</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_orphan_retries = 3</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_syncookies = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.ip_conntrack_max = 65536</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_timestamps = 0</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.core.somaxconn = 16384</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sysctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">reboot</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查询内饰是否正常加载</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lsmod</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --color=auto</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ip_vs</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nf_conntrack</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,54)]))}const k=i(e,[["render",t],["__file","index.html.vue"]]),d=JSON.parse(`{"path":"/devops/k8s/base-config/","title":"k8s安装基本配置（二进制方式）","lang":"zh-CN","frontmatter":{"title":"k8s安装基本配置（二进制方式）","createTime":"2025/04/16 21:59:33","permalink":"/devops/k8s/base-config/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;if (um === 'dark' || (um !== 'light' && sm)) {document.documentElement.classList.add('dark');}})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":3,"title":"环境准备","slug":"环境准备","link":"#环境准备","children":[]},{"level":3,"title":"基础配置","slug":"基础配置","link":"#基础配置","children":[]},{"level":3,"title":"内核升级","slug":"内核升级","link":"#内核升级","children":[]}],"readingTime":{"minutes":4.79,"words":1437},"git":{"createdTime":1745249697000,"updatedTime":1745249697000,"contributors":[{"name":"yongjun","email":"1640808365@qq.com","commits":1}]},"filePathRelative":"notes/devops/k8s/k8s安装基本配置（二进制方式）.md"}`);export{k as comp,d as data};
