import{_ as i,c as a,a as n,o as e}from"./app-CO77B8re.js";const l="/yw-docs/assets/k8s-version-CjQfo7Yp.png",t="/yw-docs/assets/k8s-files-R50pUGCo.png",p="/yw-docs/assets/etcd-status-vvNpk-Pp.png",k={};function h(d,s){return e(),a("div",null,s[0]||(s[0]=[n(`<h2 id="containerd安装" tabindex="-1"><a class="header-anchor" href="#containerd安装"><span>Containerd安装</span></a></h2><p>所有节点安装docker-ce-20.10：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker-ce-20.10.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker-ce-cli-20.10.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>配置Containerd所需的模块（所有节点）：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tee</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/modules-load.d/containerd.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">overlay</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">br_netfilter</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点加载模块：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> overlay</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> br_netfilter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点，配置Containerd所需的内核：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tee</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/sysctl.d/99-kubernetes-cri.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.bridge.bridge-nf-call-iptables  = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.ip_forward                 = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点加载内核：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sysctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所有节点配置Containerd的配置文件：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/containerd</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">containerd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> tee</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/containerd/config.toml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点将Containerd的Cgroup改为Systemd：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/containerd/config.toml</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 找到containerd.runtimes.runc.options，添加SystemdCgroup = true</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 所有节点将sandbox_image的Pause镜像改成符合自己版本的地址registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点启动Containerd，并配置开机自启动：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> containerd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点配置crictl客户端连接的运行时位置：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/crictl.yaml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">image-endpoint: unix:///run/containerd/containerd.sock</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">timeout: 10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">debug: false</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="k8s组件安装" tabindex="-1"><a class="header-anchor" href="#k8s组件安装"><span>k8s组件安装</span></a></h2><p>在k8s-master01上进行操作：</p><p>下载kubernetes安装包</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kubernetes官方仓库：https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># CHANGELOG找到对应版本 -- Server Binaries</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://dl.k8s.io/v1.30.12/kubernetes-server-linux-amd64.tar.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下载etcd安装包，在k8s的changelog中查询对应etcd版本</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/etcd-io/etcd/releases/download/v3.5.11/etcd-v3.5.11-linux-amd64.tar.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>解压安装文件：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 解压kubernetes安装文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -xf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes-server-linux-amd64.tar.gz</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --strip-components=3</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 命令详解：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># tar -xf：解压文件</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --strip-components=3：解压时跳过压缩包内的前 3 层目录</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># -C：指定解压的目标目录（change to directory）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}:通过 通配符（Brace Expansion） 指定要解压的具体文件列表</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 解压etcd安装文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -zxvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd-v3.5.11-linux-amd64.tar.gz</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --strip-components=1</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd-v3.5.11-linux-amd64/etcd{,ctl}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 解压后查看版本信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubelet</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --version</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">etcdctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> version</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>版本信息： <img src="`+l+'" alt="k8s-version.png"> 解压后/usr/local/bin/对应文件为： <img src="'+t+`" alt="k8s-files.png"></p><p>将组件发送到其他节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">MasterNodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master02 k8s-master03</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">WorkNodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-node01 k8s-node02</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> NODE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $MasterNodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> echo</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/usr/local/bin/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/etcd</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/usr/local/bin/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> NODE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $WorkNodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/kube{let,-proxy}</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/usr/local/bin/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点创建目录：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/cni/bin</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>切换分支到指定版本分支：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-ha-install</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> checkout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> manual-installation-v1.30.x</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="证书生成" tabindex="-1"><a class="header-anchor" href="#证书生成"><span>证书生成</span></a></h2><p>在k8s-master01上下载证书生成工具：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -O</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/cfssl</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -O</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/cfssljson</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/cfssljson</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="制作etcd证书" tabindex="-1"><a class="header-anchor" href="#制作etcd证书"><span>制作etcd证书</span></a></h3><p>所有Master节点创建etcd证书目录</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/etcd/ssl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所有节点创建kubernetes相关目录</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>生成etcd证书</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成etcd的ca证书和ca-key</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/pki</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -initca</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd-ca-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/etcd/ssl/etcd-ca</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 以上步骤生成文件：etcd-ca.csr  etcd-ca-key.pem  etcd-ca.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 使用etcd的ca和ca-key签发etcd证书etcd.pem和etcd-key.pem</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -ca=/etc/etcd/ssl/etcd-ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.11,192.168.1.12,192.168.1.13</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -profile=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   etcd-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/etcd/ssl/etcd</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 以上步骤生成：etcd.csr  etcd-key.pem  etcd.pem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将生成证书发送到其他节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">MasterNodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master02 k8s-master03</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> NODE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $MasterNodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     ssh</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mkdir -p /etc/etcd/ssl</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">     for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> FILE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd-ca-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  etcd-ca.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  etcd-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  etcd.pem</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/etcd/ssl/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/etc/etcd/ssl/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">     done</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="制作k8s组件证书" tabindex="-1"><a class="header-anchor" href="#制作k8s组件证书"><span>制作k8s组件证书</span></a></h3><p><strong>生成apiserver证书：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成ca根证书</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/pki</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -initca</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ca-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/ca</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 此步骤生成：ls /etc/kubernetes/pki/</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ca.csr  ca-key.pem  ca.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 使用ca签发apiserver证书</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 10.96.0.1是k8s service的网段，如果说需要更改k8s service网段，那就需要更改此网段</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 如果不是高可用集群，192.168.1.30为Master01的IP，此为虚IP地址</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=/etc/kubernetes/pki/ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -hostname=10.96.0.1,192.168.1.30,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.11,192.168.1.12,192.168.1.13</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apiserver-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/apiserver</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 此步骤生成：ls /etc/kubernetes/pki</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># apiserver.csr  apiserver-key.pem  apiserver.pem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成apiserver聚合证书：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成front-proxy-ca 根证书</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/pki</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -initca</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> front-proxy-ca-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/front-proxy-ca</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成结果：ls /etc/kubernetes/pki</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># front-proxy-ca.csr  front-proxy-ca-key.pem  front-proxy-ca.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 使用front-proxy-ca签发front-proxy-client证书</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=/etc/kubernetes/pki/front-proxy-ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> front-proxy-client-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/front-proxy-client</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成结果：ls /etc/kubernetes/pki</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># front-proxy-client.csr  front-proxy-client-key.pem  front-proxy-client.pem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成controller-manage的证书：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 签发controller-manage证书</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/pki</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=/etc/kubernetes/pki/ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> manager-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/controller-manager</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#结果：ls /etc/kubernetes/pki</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># controller-manager.csr controller-manager.pem controller-manager-key.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-cluster：设置一个集群项</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 注意，如果不是高可用集群，192.168.1.30:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --certificate-authority=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --server=https://192.168.1.30:8443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：Cluster &quot;kubernetes&quot; set.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 设置一个环境项，一个上下文</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> system:kube-controller-manager@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cluster=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --user=system:kube-controller-manager</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：Context &quot;system:kube-controller-manager@kubernetes&quot; created.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-credentials 设置一个用户项</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> system:kube-controller-manager</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --client-certificate=/etc/kubernetes/pki/controller-manager.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --client-key=/etc/kubernetes/pki/controller-manager-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：User &quot;system:kube-controller-manager&quot; set.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 使用某个环境当做默认环境</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> system:kube-controller-manager@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">结果：Switched</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> context</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">system:kube-controller-manager@kubernetes</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成scheduler证书：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成scheduler证书</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/pki</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=/etc/kubernetes/pki/ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scheduler-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/scheduler</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：scheduler.csr scheduler.pem scheduler-key.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-cluster：设置一个集群项</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 注意，如果不是高可用集群，192.168.1.30:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --certificate-authority=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --server=https://192.168.1.30:8443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-credentials 设置一个用户项</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> system:kube-scheduler</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --client-certificate=/etc/kubernetes/pki/scheduler.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --client-key=/etc/kubernetes/pki/scheduler-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-context 设置一个环境项，一个上下文</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> system:kube-scheduler@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cluster=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --user=system:kube-scheduler</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># use-context 使用某个环境当做默认环境</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> system:kube-scheduler@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成kubernetes-admin证书：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成admin证书</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/pki</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=/etc/kubernetes/pki/ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> admin-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/admin</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：admin.csr admin.pem admin-key.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-cluster：设置一个集群项</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 注意，如果不是高可用集群，192.168.1.30:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --certificate-authority=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --server=https://192.168.1.30:8443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：Cluster &quot;kubernetes&quot; set.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-credentials 设置一个用户项</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes-admin</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --client-certificate=/etc/kubernetes/pki/admin.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --client-key=/etc/kubernetes/pki/admin-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：User &quot;kubernetes-admin&quot; set.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># set-context 设置一个环境项，一个上下文</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes-admin@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cluster=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --user=kubernetes-admin</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：Context &quot;kubernetes-admin@kubernetes&quot; created.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># use-context 使用某个环境当做默认环境</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes-admin@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建ServiceAccount Key：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">openssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> genrsa</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -out</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/sa.key</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2048</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">openssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rsa</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/sa.key</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -pubout</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -out</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/sa.pub</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 结果：sa.key sa.pub</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 发送到其他主节点</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> NODE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> FILE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> $(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -v</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/etc/kubernetes/pki/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">done</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> FILE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> admin.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> controller-manager.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scheduler.kubeconfig</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/etc/kubernetes/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">done</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>至此证书文件已生成完成：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看所有证书文件信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 23个</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wc</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kubernetes系统组件配置" tabindex="-1"><a class="header-anchor" href="#kubernetes系统组件配置"><span>Kubernetes系统组件配置</span></a></h2><h3 id="etcd配置" tabindex="-1"><a class="header-anchor" href="#etcd配置"><span>Etcd配置</span></a></h3><p>etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</p><p>master01：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 注意修改IP地址</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vim /etc/etcd/etcd.config.yml</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master01</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">data-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">wal-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd/wal</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">snapshot-count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">heartbeat-interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">election-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">quota-backend-bytes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">listen-peer-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.11:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">listen-client-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.11:2379,http://127.0.0.1:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">max-snapshots</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">max-wals</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cors</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-advertise-peer-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.11:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">advertise-client-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.11:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-fallback</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">proxy</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-srv</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master01=https://192.168.1.11:2380,k8s-master02=https://192.168.1.12:2380,k8s-master03=https://192.168.1.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster-token</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-k8s-cluster</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster-state</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">new</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">strict-reconfig-check</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">enable-v2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">enable-pprof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">off</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-failure-wait</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-refresh-interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-dial-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-write-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-read-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">client-transport-security</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cert-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  key-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  client-cert-auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  trusted-ca-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  auto-tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">peer-transport-security</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cert-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  key-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  peer-client-cert-auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  trusted-ca-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  auto-tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">debug</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">log-package-levels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">log-outputs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">default</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">force-new-cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>master02：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vim /etc/etcd/etcd.config.yml</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master02</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">data-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">wal-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd/wal</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">snapshot-count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">heartbeat-interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">election-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">quota-backend-bytes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">listen-peer-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.12:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">listen-client-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.12:2379,http://127.0.0.1:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">max-snapshots</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">max-wals</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cors</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-advertise-peer-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.12:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">advertise-client-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.12:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-fallback</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">proxy</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-srv</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master01=https://192.168.1.11:2380,k8s-master02=https://192.168.1.12:2380,k8s-master03=https://192.168.1.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster-token</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-k8s-cluster</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster-state</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">new</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">strict-reconfig-check</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">enable-v2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">enable-pprof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">off</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-failure-wait</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-refresh-interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-dial-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-write-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-read-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">client-transport-security</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cert-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  key-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  client-cert-auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  trusted-ca-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  auto-tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">peer-transport-security</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cert-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  key-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  peer-client-cert-auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  trusted-ca-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  auto-tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">debug</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">log-package-levels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">log-outputs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">default</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">force-new-cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>master03：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vim /etc/etcd/etcd.config.yml</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master03</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">data-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">wal-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd/wal</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">snapshot-count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">heartbeat-interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">election-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">quota-backend-bytes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">listen-peer-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">listen-client-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.13:2379,http://127.0.0.1:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">max-snapshots</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">max-wals</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cors</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-advertise-peer-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">advertise-client-urls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.1.13:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-fallback</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">proxy</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">discovery-srv</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s-master01=https://192.168.1.11:2380,k8s-master02=https://192.168.1.12:2380,k8s-master03=https://192.168.1.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster-token</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-k8s-cluster</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">initial-cluster-state</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">new</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">strict-reconfig-check</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">enable-v2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">enable-pprof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">off</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-failure-wait</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-refresh-interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-dial-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-write-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">proxy-read-timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">client-transport-security</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cert-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  key-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  client-cert-auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  trusted-ca-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  auto-tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">peer-transport-security</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cert-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  key-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  peer-client-cert-auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  trusted-ca-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  auto-tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">debug</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">log-package-levels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">log-outputs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">default</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">force-new-cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建Etcd的Service服务：</strong></p><p>所有Master节点创建etcd service并启动。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/etcd.service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 添加以下内容</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Unit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Description</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Etcd</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Service</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Documentation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://coreos.com/etcd/docs/latest/</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">After</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Type</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">notify</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ExecStart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/usr/local/bin/etcd</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> --config-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/etcd/etcd.config.yml</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Restart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">on-failure</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">RestartSec</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">10</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">LimitNOFILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">65536</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Install</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">WantedBy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Alias</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd3.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有master创建etcd证书目录：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/etcd</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ln</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/etcd/ssl/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/etcd/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看etcd状态：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看是否有报错日志信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tail</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -200f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/messages</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看集群状态</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">export</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --endpoints=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.1.11:2379,192.168.1.12:2379,192.168.1.13:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cert=/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --key=/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  endpoint</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --write-out=table</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+p+`" alt="etcd-status.png"></p><h2 id="master节点高可用配置" tabindex="-1"><a class="header-anchor" href="#master节点高可用配置"><span>master节点高可用配置</span></a></h2><p>注意：如果不是高可用集群，haproxy和keepalived无需安装</p><p>如果在云上也无需执行以下配置，可以直接使用云上的lb，比如阿里云slb，腾讯云elb等</p><p>公有云要用公有云自带的负载均衡，比如阿里云的SLB，腾讯云的ELB，用来替代haproxy和keepalived，因为公有云大部分都是不支持keepalived的，另外如果用阿里云的话，kubectl控制端不能放在master节点，推荐使用腾讯云，因为阿里云的slb有回环的问题，也就是slb代理的服务器不能反向访问SLB，但是腾讯云修复了这个问题。</p><p>所有Master节点安装keepalived和haproxy</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> haproxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>所有Master配置HAProxy，配置一样</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/haproxy/haproxy.cfg</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">global</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  maxconn</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  2000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ulimit-n</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  16384</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  log</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  127.0.0.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> local0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> err</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  stats</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 30s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">defaults</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  mode</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  http</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  option</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  httplog</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> connect</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> client</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  50000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  50000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http-request</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 15s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timeout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http-keep-alive</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 15s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">frontend</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  bind</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 0.0.0.0:8443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  bind</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:8443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  mode</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tcp</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  option</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tcplog</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  tcp-request</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect-delay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  default_backend</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">backend</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  mode</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tcp</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  option</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tcplog</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  option</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tcp-check</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  balance</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> roundrobin</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  default-server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inter</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> downinter</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rise</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fall</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> slowstart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 60s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> maxconn</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 250</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> maxqueue</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 256</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> weight</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    192.168.1.11:6443</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  check</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    192.168.1.12:6443</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  check</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    192.168.1.13:6443</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  check</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="keepalived配置" tabindex="-1"><a class="header-anchor" href="#keepalived配置"><span>keepalived配置</span></a></h3><p>所有Master节点配置KeepAlived，配置不一样，注意区分，注意每个节点的IP和网卡（interface参数）</p><p><strong>master01:</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Configuration</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> File</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> for</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">global_defs</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    router_id</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> LVS_DEVEL</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vrrp_script</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> chk_apiserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    script</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/keepalived/check_apiserver.sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    interval</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    weight</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    fall</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    rise</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vrrp_instance</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> VI_1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> MASTER</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    interface</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ens33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    mcast_src_ip</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.1.11</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    virtual_router_id</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 51</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    priority</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 101</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    nopreempt</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    advert_int</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    authentication</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        auth_type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        auth_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> K8SHA_KA_AUTH</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    virtual_ipaddress</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        192.168.1.30</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    track_script</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      chk_apiserver</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>master02:</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vim /etc/keepalived/keepalived.conf</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 文件内容</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Configuration</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> File</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> for</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">global_defs</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    router_id</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> LVS_DEVEL</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vrrp_script</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> chk_apiserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    script</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/keepalived/check_apiserver.sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    interval</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    weight</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    fall</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    rise</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vrrp_instance</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> VI_1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> BACKUP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    interface</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ens33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    mcast_src_ip</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.1.12</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    virtual_router_id</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 51</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    priority</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    nopreempt</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    advert_int</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    authentication</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        auth_type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        auth_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> K8SHA_KA_AUTH</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    virtual_ipaddress</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        192.168.1.30</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    track_script</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      chk_apiserver</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>master03:</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vim /etc/keepalived/keepalived.conf</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 文件内容</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Configuration</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> File</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> for</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">global_defs</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    router_id</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> LVS_DEVEL</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vrrp_script</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> chk_apiserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    script</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/keepalived/check_apiserver.sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    interval</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    weight</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    fall</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    rise</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vrrp_instance</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> VI_1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> BACKUP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    interface</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ens33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    mcast_src_ip</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.1.13</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    virtual_router_id</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 51</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    priority</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    nopreempt</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    advert_int</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    authentication</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        auth_type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        auth_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> K8SHA_KA_AUTH</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    virtual_ipaddress</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        192.168.1.30</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    track_script</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      chk_apiserver</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>健康检查配置：</strong></p><p>所有master节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vim /etc/keepalived/check_apiserver.sh</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">err</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> k</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> $(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">seq</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">do</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    check_code</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pgrep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> haproxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $check_code</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ]];</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> then</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        err</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">expr</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $err</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        sleep</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        continue</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    else</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        err</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        break</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    fi</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $err</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ]];</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> then</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">systemctl stop keepalived</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    /usr/bin/systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stop</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    exit</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">else</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    exit</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 添加可执行权限</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/keepalived/check_apiserver.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有master节点启动haproxy和keepalived</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> haproxy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看服务状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> haproxy</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>VIP测试</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ping</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.1.30</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看虚IP落在哪个节点上</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ip</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重要：如果安装了keepalived和haproxy，需要测试keepalived是否是正常的</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 将虚IP所在节点关机查看是否还能ping通虚IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">telnet</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.1.30</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8443</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果ping不通且telnet没有出现&quot;Escape character is &#39;^]&#39;.&quot;，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看防火墙状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> firewalld</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看selinux状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getenforce</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看haproxy和keepalived状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> haproxy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看监听端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -lntp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kubernetes组件配置" tabindex="-1"><a class="header-anchor" href="#kubernetes组件配置"><span>Kubernetes组件配置</span></a></h2><p>初始化：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 所有节点创建相关目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests/</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/systemd/system/kubelet.service.d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/kubelet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/kubernetes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="apiserver" tabindex="-1"><a class="header-anchor" href="#apiserver"><span>Apiserver：</span></a></h3><p>所有Master节点创建kube-apiserver service。</p><p>master01配置：</p><p>注意本文档使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-apiserver.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-apiserver </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --v=2  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --allow-privileged=true  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --bind-address=0.0.0.0  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --secure-port=6443  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --advertise-address=192.168.1.11 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-cluster-ip-range=10.96.0.0/12  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-node-port-range=30000-32767  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-servers=https://192.168.1.11:2379,https://192.168.1.12:2379,https://192.168.1.13:2379 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --client-ca-file=/etc/kubernetes/pki/ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-issuer=https://kubernetes.default.svc.cluster.local </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --authorization-mode=Node,RBAC  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-bootstrap-token-auth=true  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-allowed-names=aggregator  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-group-headers=X-Remote-Group  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-extra-headers-prefix=X-Remote-Extra-  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-username-headers=X-Remote-User </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-aggregator-routing=true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LimitNOFILE=65535</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>master02配置：</p><p>注意本文档使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改！</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-apiserver.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-apiserver </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --v=2  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --allow-privileged=true  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --bind-address=0.0.0.0  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --secure-port=6443  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --advertise-address=192.168.1.12 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-cluster-ip-range=10.96.0.0/12  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-node-port-range=30000-32767  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-servers=https://192.168.1.11:2379,https://192.168.1.12:2379,https://192.168.1.13:2379 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --client-ca-file=/etc/kubernetes/pki/ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-issuer=https://kubernetes.default.svc.cluster.local </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --authorization-mode=Node,RBAC  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-bootstrap-token-auth=true  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-allowed-names=aggregator  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-group-headers=X-Remote-Group  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-extra-headers-prefix=X-Remote-Extra-  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-username-headers=X-Remote-User </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-aggregator-routing=true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LimitNOFILE=65535</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>master03配置：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-apiserver.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-apiserver </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --v=2  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --allow-privileged=true  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --bind-address=0.0.0.0  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --secure-port=6443  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --advertise-address=192.168.1.13 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-cluster-ip-range=10.96.0.0/12  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-node-port-range=30000-32767  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-servers=https://192.168.1.11:2379,https://192.168.1.12:2379,https://192.168.1.13:2379 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --client-ca-file=/etc/kubernetes/pki/ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-issuer=https://kubernetes.default.svc.cluster.local </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --authorization-mode=Node,RBAC  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-bootstrap-token-auth=true  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-allowed-names=aggregator  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-group-headers=X-Remote-Group  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-extra-headers-prefix=X-Remote-Extra-  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-username-headers=X-Remote-User </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --enable-aggregator-routing=true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LimitNOFILE=65535</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有master节点启动ApiServer：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启用并立即启动kube-apiserver.service单元。kube-apiserver.service是kube-apiserver守护进程的systemd服务单元。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重启kube-apiserver.service单元，即重新启动etcd守护进程。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kube-apiserver.service单元的当前状态，包括运行状态、是否启用等信息。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="controllermanager" tabindex="-1"><a class="header-anchor" href="#controllermanager"><span>ControllerManager：</span></a></h3><p>所有Master节点配置kube-controller-manager service</p><p>注意本文档使用的k8s Pod网段为172.16.0.0/12，该网段不能和宿主机的网段、k8s Service的网段重复，请按需修改</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 关闭IPv6 </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 删除 --service-cluster-ip-range 中的IPv6地址</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 删除 --cluster-cidr 中的IPv6地址</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 删除 --node-cidr-mask-size-ipv6=120</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-controller-manager.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Controller Manager</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-controller-manager </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --v=2 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --bind-address=0.0.0.0 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --root-ca-file=/etc/kubernetes/pki/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --leader-elect=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --use-service-account-credentials=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --node-monitor-grace-period=40s </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --node-monitor-period=5s </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --controllers=*,bootstrapsigner,tokencleaner </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --allocate-node-cidrs=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --service-cluster-ip-range=10.96.0.0/12 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --cluster-cidr=172.16.0.0/12 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --node-cidr-mask-size-ipv4=24 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=always</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有Master节点启动kube-controller-manager：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启用并立即启动kube-controller-manager.service单元。kube-controller-manager.service是kube-controller-manager守护进程的systemd服务单元。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重启kube-controller-manager.service单元，即重新启动etcd守护进程。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kube-controller-manager.service单元的当前状态，包括运行状态、是否启用等信息。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置kube-scheduler-service" tabindex="-1"><a class="header-anchor" href="#配置kube-scheduler-service"><span>配置kube-scheduler service：</span></a></h3><p>所有master节点配置，且配置相同</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-scheduler.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Scheduler</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-scheduler </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --v=2 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --bind-address=0.0.0.0 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --leader-elect=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=always</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点启动scheduler：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启用并立即启动kube-scheduler.service单元。kube-scheduler.service是kube-scheduler守护进程的systemd服务单元。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重启kube-scheduler.service单元，即重新启动etcd守护进程。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kube-scheduler.service单元的当前状态，包括运行状态、是否启用等信息。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="tls-bootstrapping配置" tabindex="-1"><a class="header-anchor" href="#tls-bootstrapping配置"><span>TLS Bootstrapping配置</span></a></h2><p>在Master01创建bootstrap</p><p>注意，如果不是高可用集群，192.168.1.30:8443改为master01的地址，8443改为apiserver的端口，默认是6443</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个使用 kubectl 命令设置 Kubernetes 集群配置的命令示例。下面是对每个选项的详细解释：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># config set-cluster kubernetes：指定要设置的集群名称为 &quot;kubernetes&quot;，表示要修改名为 &quot;kubernetes&quot; 的集群配置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --certificate-authority=/etc/kubernetes/pki/ca.pem：指定证书颁发机构（CA）的证书文件路径，用于验证服务器证书的有效性。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --embed-certs=true：将证书文件嵌入到生成的 kubeconfig 文件中。这样可以避免在 kubeconfig 文件中引用外部证书文件。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --server=https://192.168.1.30:8443：指定 Kubernetes API 服务器的地址和端口。你可以根据实际环境修改该参数。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过执行此命令，你可以设置名为 &quot;kubernetes&quot; 的集群配置，并提供 CA 证书、API 服务器地址和端口，并将这些配置信息嵌入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--certificate-authority=/etc/kubernetes/pki/ca.pem     </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--embed-certs=true     </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">--server=https://192.168.1.30:8443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 可以使用这个命令进行创建token也可以使用示例</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">head</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /dev/urandom </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> md5sum</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> head</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 6</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">head</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 16</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /dev/urandom </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> md5sum</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> head</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 16</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个使用 kubectl 命令设置凭证信息的命令示例。下面是对每个选项的详细解释：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># config set-credentials tls-bootstrap-token-user：指定要设置的凭证名称为 &quot;tls-bootstrap-token-user&quot;，表示要修改名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --token=f74c0b.1d0be5beef3714ff：指定用户的身份验证令牌（token）。在这个示例中，令牌是 f74c0b.1d0be5beef3714ff。你可以根据实际情况修改该令牌。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过执行此命令，你可以设置名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证，并将令牌信息加入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tls-bootstrap-token-user</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--token=f74c0b.1d0be5beef3714ff </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个使用 kubectl 命令设置上下文信息的命令示例。下面是对每个选项的详细解释：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># config set-context tls-bootstrap-token-user@kubernetes：指定要设置的上下文名称为 &quot;tls-bootstrap-token-user@kubernetes&quot;，表示要修改名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文配置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --cluster=kubernetes：指定上下文关联的集群名称为 &quot;kubernetes&quot;，表示使用名为 &quot;kubernetes&quot; 的集群配置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --user=tls-bootstrap-token-user：指定上下文关联的用户凭证名称为 &quot;tls-bootstrap-token-user&quot;，表示使用名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过执行此命令，你可以设置名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文，并将其关联到名为 &quot;kubernetes&quot; 的集群配置和名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。这样，bootstrap-kubelet.kubeconfig 文件就包含了完整的上下文信息，可以用于指定与 Kubernetes 集群建立连接时要使用的集群和凭证。请确保路径和文件名与实际环境中的配置相匹配。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tls-bootstrap-token-user@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--cluster=kubernetes     </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--user=tls-bootstrap-token-user     </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个使用 kubectl 命令设置当前上下文的命令示例。下面是对每个选项的详细解释：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># config use-context tls-bootstrap-token-user@kubernetes：指定要使用的上下文名称为 &quot;tls-bootstrap-token-user@kubernetes&quot;，表示要将当前上下文切换为名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过执行此命令，你可以将当前上下文设置为名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文。这样，当你执行其他 kubectl 命令时，它们将使用该上下文与 Kubernetes 集群进行交互。请确保路径和文件名与实际环境中的配置相匹配。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tls-bootstrap-token-user@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/.kube</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/admin.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/.kube/config</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 如果你希望使用自定义的 ServiceAccount 的 Token（而不是管理员的 Token），需要手动修改 .kube/config 文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/.kube</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/admin.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/.kube/config</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检查当前集群状态" tabindex="-1"><a class="header-anchor" href="#检查当前集群状态"><span>检查当前集群状态：</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看etcd 状态</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">export</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --endpoints=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.1.11:2379,192.168.1.12:2379,192.168.1.13:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cert=/etc/kubernetes/pki/etcd/etcd.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --key=/etc/kubernetes/pki/etcd/etcd-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  endpoint</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --write-out=table</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">     ENDPOINT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ID</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> VERSION</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> DB</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> SIZE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> IS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> LEADER</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> IS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> LEARNER</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> RAFT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TERM</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> RAFT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> INDEX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> RAFT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> APPLIED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> INDEX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ERRORS</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 192.168.1.11:2379</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ace8d5b0766b3d92</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  3.5.11</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  991</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">     false</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      false</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">         6</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       5501</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">               5501</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 192.168.1.12:2379</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ac7e57d44f030e8</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  3.5.11</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  987</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      true</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      false</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">         6</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       5501</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">               5501</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 192.168.1.13:2379</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 40ba37809e1a423f</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  3.5.11</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  995</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">     false</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      false</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">         6</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       5501</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">               5501</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Warning:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ComponentStatus</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> is</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deprecated</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1.19+</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                 STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    MESSAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   ERROR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">controller-manager</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Healthy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   ok</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scheduler</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            Healthy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   ok</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">etcd-0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               Healthy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   ok</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 写入bootstrap-token</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bootstrap.secret.yaml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: Secret</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: bootstrap-token-f74c0b</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  namespace: kube-system</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">type: bootstrap.kubernetes.io/token</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">stringData:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  description: &quot;The default bootstrap token generated by &#39;kubelet &#39;.&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  token-id: f74c0b</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  token-secret: 1d0be5beef3714ff</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  usage-bootstrap-authentication: &quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  usage-bootstrap-signing: &quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">---</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: kubelet-bootstrap</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">roleRef:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: ClusterRole</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:node-bootstrapper</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">subjects:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">- apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: Group</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:bootstrappers:default-node-token</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">---</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: node-autoapprove-bootstrap</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">roleRef:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: ClusterRole</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">subjects:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">- apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: Group</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:bootstrappers:default-node-token</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">---</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: node-autoapprove-certificate-rotation</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">roleRef:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: ClusterRole</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">subjects:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">- apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: Group</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:nodes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">---</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: ClusterRole</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  annotations:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    kubernetes.io/bootstrapping: rbac-defaults</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:kube-apiserver-to-kubelet</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">rules:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  - apiGroups:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    resources:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - nodes/proxy</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - nodes/stats</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - nodes/log</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - nodes/spec</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - nodes/metrics</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    verbs:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - &quot;*&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">---</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: ClusterRoleBinding</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  namespace: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">roleRef:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kind: ClusterRole</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: system:kube-apiserver-to-kubelet</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">subjects:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  - apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    kind: User</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    name: kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 关键步骤请勿遗漏！！！</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bootstrap.secret.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="node节点配置" tabindex="-1"><a class="header-anchor" href="#node节点配置"><span>Node节点配置</span></a></h2><h3 id="复制证书" tabindex="-1"><a class="header-anchor" href="#复制证书"><span>复制证书</span></a></h3><p>Master01节点复制证书至Node节点</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> NODE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node02</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ssh</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> FILE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pki/ca.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pki/ca-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pki/front-proxy-ca.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bootstrap-kubelet.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy.kubeconfig</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$FILE</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/etc/kubernetes/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kubelet配置" tabindex="-1"><a class="header-anchor" href="#kubelet配置"><span>Kubelet配置</span></a></h3><p>所有节点创建相关目录</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/kubelet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/systemd/system/kubelet.service.d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所有节点配置kubelet service</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/kubelet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/systemd/system/kubelet.service.d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 所有k8s节点配置kubelet service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kubelet.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network-online.target firewalld.service containerd.service</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Wants=network-online.target</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Requires=containerd.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kubelet </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --config=/etc/kubernetes/kubelet-conf.yml </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --node-labels=node.kubernetes.io/node=</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。与之前相比，添加了 After 和 Requires 字段来指定依赖关系。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># [Unit]</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 &quot;Kubernetes Kubelet&quot;。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Documentation=...：指定了对该服务的文档链接。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># [Service]</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数，与之前的示例相同。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># --container-runtime-endpoint=unix:///run/containerd/containerd.sock：修改了容器运行时接口的端点地址，将其更改为使用 containerd 运行时（通过 UNIX 套接字）。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># [Install]</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过这个单位文件，你可以配置 Kubelet 服务的启动参数，并指定了它依赖的 containerd 服务。确保路径和文件名与你实际环境中的配置相匹配。</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IPv6示例</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 若不使用IPv6那么忽略此项即可</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 下方 --node-ip 更换为每个节点的IP即可</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kubelet.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network-online.target firewalld.service containerd.service</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Wants=network-online.target</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Requires=containerd.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kubelet </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --config=/etc/kubernetes/kubelet-conf.yml </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --node-labels=node.kubernetes.io/node=  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    --node-ip=192.168.1.41,2408:822a:245:8c01::fab</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有节点配置kubelet service的配置文件</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/kubelet-conf.yml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">address: 0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">port: 10250</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">readOnlyPort: 10255</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">authentication:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  anonymous:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    enabled: false</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  webhook:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cacheTTL: 2m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    enabled: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  x509:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    clientCAFile: /etc/kubernetes/pki/ca.pem</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">authorization:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  mode: Webhook</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  webhook:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cacheAuthorizedTTL: 5m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cacheUnauthorizedTTL: 30s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cgroupDriver: systemd</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cgroupsPerQOS: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clusterDNS:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">- 10.96.0.10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clusterDomain: cluster.local</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">containerLogMaxFiles: 5</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">containerLogMaxSize: 10Mi</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">contentType: application/vnd.kubernetes.protobuf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cpuCFSQuota: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cpuManagerPolicy: none</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cpuManagerReconcilePeriod: 10s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">enableControllerAttachDetach: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">enableDebuggingHandlers: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">enforceNodeAllocatable:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">- pods</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">eventBurst: 10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">eventRecordQPS: 5</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">evictionHard:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  imagefs.available: 15%</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  memory.available: 100Mi</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nodefs.available: 10%</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nodefs.inodesFree: 5%</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">evictionPressureTransitionPeriod: 5m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">failSwapOn: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fileCheckFrequency: 20s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hairpinMode: promiscuous-bridge</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">healthzBindAddress: 127.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">healthzPort: 10248</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">httpCheckFrequency: 20s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">imageGCHighThresholdPercent: 85</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">imageGCLowThresholdPercent: 80</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">imageMinimumGCAge: 2m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">iptablesDropBit: 15</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">iptablesMasqueradeBit: 14</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kubeAPIBurst: 10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kubeAPIQPS: 5</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">makeIPTablesUtilChains: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">maxOpenFiles: 1000000</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">maxPods: 110</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nodeStatusUpdateFrequency: 10s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">oomScoreAdj: -999</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">podPidsLimit: -1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registryBurst: 10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registryPullQPS: 5</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">resolvConf: /etc/resolv.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">rotateCertificates: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">runtimeRequestTimeout: 2m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">serializeImagePulls: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">staticPodPath: /etc/kubernetes/manifests</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">streamingConnectionIdleTimeout: 4h0m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">syncFrequency: 1m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">volumeStatsAggPeriod: 1m0s</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个Kubelet的配置文件，用于配置Kubelet的各项参数。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - apiVersion: kubelet.config.k8s.io/v1beta1：指定了配置文件的API版本为kubelet.config.k8s.io/v1beta1。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - kind: KubeletConfiguration：指定了配置类别为KubeletConfiguration。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - address: 0.0.0.0：指定了Kubelet监听的地址为0.0.0.0。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - port: 10250：指定了Kubelet监听的端口为10250。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - readOnlyPort: 10255：指定了只读端口为10255，用于提供只读的状态信息。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - authentication：指定了认证相关的配置信息。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - anonymous.enabled: false：禁用了匿名认证。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - webhook.enabled: true：启用了Webhook认证。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - x509.clientCAFile: /etc/kubernetes/pki/ca.pem：指定了X509证书的客户端CA文件路径。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - authorization：指定了授权相关的配置信息。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - mode: Webhook：指定了授权模式为Webhook。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - webhook.cacheAuthorizedTTL: 5m0s：指定了授权缓存时间段为5分钟。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - webhook.cacheUnauthorizedTTL: 30s：指定了未授权缓存时间段为30秒。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - cgroupDriver: systemd：指定了Cgroup驱动为systemd。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - cgroupsPerQOS: true：启用了每个QoS类别一个Cgroup的设置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - clusterDNS: 指定了集群的DNS服务器地址列表。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - 10.96.0.10：指定了DNS服务器地址为10.96.0.10。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - clusterDomain: cluster.local：指定了集群的域名后缀为cluster.local。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - containerLogMaxFiles: 5：指定了容器日志文件保留的最大数量为5个。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - containerLogMaxSize: 10Mi：指定了容器日志文件的最大大小为10Mi。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - contentType: application/vnd.kubernetes.protobuf：指定了内容类型为protobuf。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - cpuCFSQuota: true：启用了CPU CFS Quota。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - cpuManagerPolicy: none：禁用了CPU Manager。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - cpuManagerReconcilePeriod: 10s：指定了CPU管理器的调整周期为10秒。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - enableControllerAttachDetach: true：启用了控制器的挂载和拆卸。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - enableDebuggingHandlers: true：启用了调试处理程序。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - enforceNodeAllocatable: 指定了强制节点可分配资源的列表。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - pods：强制节点可分配pods资源。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - eventBurst: 10：指定了事件突发的最大数量为10。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - eventRecordQPS: 5：指定了事件记录的最大请求量为5。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - evictionHard: 指定了驱逐硬性限制参数的配置信息。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - imagefs.available: 15%：指定了镜像文件系统可用空间的限制为15%。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - memory.available: 100Mi：指定了可用内存的限制为100Mi。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - nodefs.available: 10%：指定了节点文件系统可用空间的限制为10%。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - nodefs.inodesFree: 5%：指定了节点文件系统可用inode的限制为5%。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - evictionPressureTransitionPeriod: 5m0s：指定了驱逐压力转换的时间段为5分钟。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - failSwapOn: true：指定了在发生OOM时禁用交换分区。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - fileCheckFrequency: 20s：指定了文件检查频率为20秒。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - hairpinMode: promiscuous-bridge：设置了Hairpin Mode为&quot;promiscuous-bridge&quot;。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - healthzBindAddress: 127.0.0.1：指定了健康检查的绑定地址为127.0.0.1。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - healthzPort: 10248：指定了健康检查的端口为10248。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - httpCheckFrequency: 20s：指定了HTTP检查的频率为20秒。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - imageGCHighThresholdPercent: 85：指定了镜像垃圾回收的上阈值为85%。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - imageGCLowThresholdPercent: 80：指定了镜像垃圾回收的下阈值为80%。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - imageMinimumGCAge: 2m0s：指定了镜像垃圾回收的最小时间为2分钟。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - iptablesDropBit: 15：指定了iptables的Drop Bit为15。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - iptablesMasqueradeBit: 14：指定了iptables的Masquerade Bit为14。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - kubeAPIBurst: 10：指定了KubeAPI的突发请求数量为10个。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - kubeAPIQPS: 5：指定了KubeAPI的每秒请求频率为5个。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - makeIPTablesUtilChains: true：指定了是否使用iptables工具链。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - maxOpenFiles: 1000000：指定了最大打开文件数为1000000。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - maxPods: 110：指定了最大的Pod数量为110。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - nodeStatusUpdateFrequency: 10s：指定了节点状态更新的频率为10秒。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - oomScoreAdj: -999：指定了OOM Score Adjustment为-999。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - podPidsLimit: -1：指定了Pod的PID限制为-1，表示无限制。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - registryBurst: 10：指定了Registry的突发请求数量为10个。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - registryPullQPS: 5：指定了Registry的每秒拉取请求数量为5个。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - resolvConf: /etc/resolv.conf：指定了resolv.conf的文件路径。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - rotateCertificates: true：指定了是否轮转证书。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - runtimeRequestTimeout: 2m0s：指定了运行时请求的超时时间为2分钟。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - serializeImagePulls: true：指定了是否序列化镜像拉取。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - staticPodPath: /etc/kubernetes/manifests：指定了静态Pod的路径。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - streamingConnectionIdleTimeout: 4h0m0s：指定了流式连接的空闲超时时间为4小时。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - syncFrequency: 1m0s：指定了同步频率为1分钟。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - volumeStatsAggPeriod: 1m0s：指定了卷统计聚合周期为1分钟。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动所有节点kubelet</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启用并立即启动kubelet.service单元。kubelet.service是kubelet守护进程的systemd服务单元。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重启kubelet.service单元，即重新启动kubelet守护进程。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kubelet.service单元的当前状态，包括运行状态、是否启用等信息。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看当前集群状态</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kubectl所在机器（此为master01）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     ROLES</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    AGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     VERSION</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k8s-master01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   NotReady</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   3m12s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   v1.30.11</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   NotReady</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   3m14s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   v1.30.11</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k8s-master03</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   NotReady</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   3m16s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   v1.30.11</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k8s-node01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     NotReady</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   3m13s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   v1.30.11</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k8s-node02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     NotReady</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   3m11s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   v1.30.11</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看容器运行时</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> describe</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Runtime</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Container</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Runtime</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Version:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containerd://1.6.33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Container</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Runtime</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Version:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containerd://1.6.33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Container</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Runtime</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Version:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containerd://1.6.33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Container</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Runtime</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Version:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containerd://1.6.33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Container</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Runtime</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Version:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containerd://1.6.33</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kube-proxy配置" tabindex="-1"><a class="header-anchor" href="#kube-proxy配置"><span>kube-proxy配置</span></a></h3><p>创建kube-proxy证书：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;key&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;size&quot;: 2048</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  },</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;names&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;C&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;ST&quot;: &quot;Beijing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;L&quot;: &quot;Beijing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;O&quot;: &quot;system:kube-proxy&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  ]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这段代码是一个JSON格式的配置文件，用于创建和配置一个名为&quot;kube-proxy-csr&quot;的Kubernetes凭证。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这个凭证包含以下字段：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - &quot;CN&quot;: &quot;system:kube-proxy&quot;: 这是凭证的通用名称，表示这是一个管理员凭证。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - &quot;key&quot;: 这是一个包含证书密钥相关信息的对象。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;algo&quot;: &quot;rsa&quot;：这是使用的加密算法类型，这里是RSA加密算法。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;size&quot;: 2048：这是密钥的大小，这里是2048位。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - &quot;names&quot;: 这是一个包含证书名称信息的数组。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;C&quot;: &quot;CN&quot;：这是证书的国家/地区字段，这里是中国。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;ST&quot;: &quot;Beijing&quot;：这是证书的省/州字段，这里是北京。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;L&quot;: &quot;Beijing&quot;：这是证书的城市字段，这里是北京。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;O&quot;: &quot;system:kube-proxy&quot;：这是证书的组织字段，这里是system:kube-proxy。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#   - &quot;OU&quot;: &quot;Kubernetes-manual&quot;：这是证书的部门字段，这里是Kubernetes-manual。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过这个配置文件创建的凭证将具有管理员权限，并且可以用于管理Kubernetes集群。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -ca=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -ca-key=/etc/kubernetes/pki/ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">   -profile=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   kube-proxy-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/pki/kube-proxy</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 上述命令是使用cfssl工具生成kube-proxy的证书。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 具体解释如下：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 1. \`cfssl gencert\`：使用cfssl工具生成证书。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 2. \`-ca=/etc/kubernetes/pki/ca.pem\`：指定根证书文件的路径。在这里，是指定根证书的路径为\`/etc/kubernetes/pki/ca.pem\`。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 3. \`-ca-key=/etc/kubernetes/pki/ca-key.pem\`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为\`/etc/kubernetes/pki/ca-key.pem\`。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 4. \`-config=ca-config.json\`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为\`ca-config.json\`。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 5. \`-profile=kubernetes\`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的\`kubernetes\`配置模板。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 6. \`kube-proxy-csr.json\`：指定admin的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为\`kube-proxy-csr.json\`。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 7. \`|\`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 8. \`cfssljson\`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 9. \`-bare /etc/kubernetes/pki/kube-proxy\`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：\`/etc/kubernetes/pki/kube-proxy.pem\`（包含了证书）、\`/etc/kubernetes/pki/kube-proxy-key.pem\`（包含了私钥）。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 若使用 haproxy、keepalived 那么为 \`--server=https://192.168.1.30:8443\`</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --certificate-authority=/etc/kubernetes/pki/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --server=https://192.168.1.30:8443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 该命令用于配置一个名为&quot;kubernetes&quot;的集群，并将其应用到/etc/kubernetes/kube-proxy.kubeconfig文件中。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 该命令的解释如下：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`kubectl config set-cluster kubernetes\`: 设置一个集群并命名为&quot;kubernetes&quot;。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--certificate-authority=/etc/kubernetes/pki/ca.pem\`: 指定集群使用的证书授权机构的路径。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--embed-certs=true\`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--server=https://127.0.0.1:8443\`: 指定集群的 API server 位置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig\`: 指定要保存 kubeconfig 文件的路径和名称。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这段命令是用于设置 kube-proxy 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 解释每个选项的含义如下：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`kubectl config set-credentials kube-proxy\`：设置 \`kube-proxy\` 用户的身份验证凭据。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--client-certificate=/etc/kubernetes/pki/kube-proxy.pem\`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 kube-proxy 组件的证书文件路径。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--client-key=/etc/kubernetes/pki/kube-proxy-key.pem\`：指定与客户端证书相对应的客户端私钥文件。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--embed-certs=true\`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig\`：指定生成的 kubeconfig 文件的路径和名称。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 该命令的目的是为 kube-proxy 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --cluster=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --user=kube-proxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">     \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 该命令用于设置一个名为&quot;kube-proxy@kubernetes&quot;的上下文，具体配置如下：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 1. --cluster=kubernetes: 指定集群的名称为&quot;kubernetes&quot;，这个集群是在当前的kubeconfig文件中已经定义好的。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 2. --user=kube-proxy: 指定用户的名称为&quot;kube-proxy&quot;，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权kube-proxy组件访问Kubernetes集群的权限。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 3. --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig: 指定kubeconfig文件的路径为&quot;/etc/kubernetes/kube-proxy.kubeconfig&quot;，这个文件将被用来保存上下文的配置信息。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy@kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 上述命令是使用\`kubectl\`命令来配置Kubernetes集群中的调度器组件。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># \`kubectl config use-context\`命令用于切换\`kubectl\`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定\`kubectl\`的连接目标。下面解释这个命令的不同部分：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`kube-proxy@kubernetes\`是一个上下文名称。它指定了使用\`kube-proxy\`用户和\`kubernetes\`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - \`--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig\`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过运行以上命令，\`kubectl\`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将证书信息发送到其他节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># master-1执行</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> NODE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master02</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-master03</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node01</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-node02</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/kube-proxy.kubeconfig</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:/etc/kubernetes/kube-proxy.kubeconfig</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="所有k8s节点添加kube-proxy的service文件" tabindex="-1"><a class="header-anchor" href="#所有k8s节点添加kube-proxy的service文件"><span>所有k8s节点添加kube-proxy的service文件</span></a></h4><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /usr/lib/systemd/system/kube-proxy.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Kube Proxy</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-proxy </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  --config=/etc/kubernetes/kube-proxy.yaml </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  --cluster-cidr=172.16.0.0/12,fc00:2222::/112 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  --v=2</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=always</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 关闭IPv6</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 删除 --cluster-cidr 的IPv6地址</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /usr/lib/systemd/system/kube-proxy.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Kube Proxy</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/usr/local/bin/kube-proxy </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  --config=/etc/kubernetes/kube-proxy.yaml </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  --cluster-cidr=172.16.0.0/12 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  --v=2</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=always</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartSec=10s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个 systemd 服务单元文件的示例，用于配置 Kubernetes Kube Proxy 服务。下面是对其中一些字段的详细解释：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># [Unit]</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Description: 描述了该服务单元的用途，这里是 Kubernetes Kube Proxy。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Documentation: 指定了该服务单元的文档地址，即 https://github.com/kubernetes/kubernetes。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># After: 指定该服务单元应在 network.target（网络目标）之后启动。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># [Service]</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ExecStart: 指定了启动 Kube Proxy 服务的命令。通过 /usr/local/bin/kube-proxy 命令启动，并指定了配置文件的路径为 /etc/kubernetes/kube-proxy.yaml，同时指定了日志级别为 2。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Restart: 配置了服务在失败或退出后自动重启。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># RestartSec: 配置了重启间隔，这里是每次重启之间的等待时间为 10 秒。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># [Install]</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># WantedBy: 指定了该服务单元的安装目标为 multi-user.target（多用户目标），表示该服务将在多用户模式下启动。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 通过配置这些字段，你可以启动和管理 Kubernetes Kube Proxy 服务。请注意，你需要根据实际情况修改 ExecStart 中的路径和文件名，确保与你的环境一致。另外，可以根据需求修改其他字段的值，以满足你的特定要求。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="所有k8s节点添加kube-proxy的配置" tabindex="-1"><a class="header-anchor" href="#所有k8s节点添加kube-proxy的配置"><span>所有k8s节点添加kube-proxy的配置</span></a></h4><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/kube-proxy.yaml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">bindAddress: 0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clientConnection:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  acceptContentTypes: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  burst: 10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  contentType: application/vnd.kubernetes.protobuf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  qps: 5</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clusterCIDR: 172.16.0.0/12</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">configSyncPeriod: 15m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">conntrack:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  max: null</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  maxPerCore: 32768</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  min: 131072</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  tcpCloseWaitTimeout: 1h0m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  tcpEstablishedTimeout: 24h0m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">enableProfiling: false</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">healthzBindAddress: 0.0.0.0:10256</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hostnameOverride: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">iptables:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  masqueradeAll: false</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  masqueradeBit: 14</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  minSyncPeriod: 0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  syncPeriod: 30s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ipvs:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  masqueradeAll: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  minSyncPeriod: 5s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  scheduler: &quot;rr&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  syncPeriod: 30s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metricsBindAddress: 127.0.0.1:10249</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mode: &quot;ipvs&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nodePortAddresses: null</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">oomScoreAdj: -999</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">portRange: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">udpIdleTimeout: 250ms</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这是一个Kubernetes的kube-proxy组件配置文件示例。以下是每个配置项的详细解释：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 1. apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 指定该配置文件的API版本。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 2. bindAddress: 0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 指定kube-proxy使用的监听地址。0.0.0.0表示监听所有网络接口。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 3. clientConnection:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 客户端连接配置项。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    a. acceptContentTypes: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定接受的内容类型。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    b. burst: 10</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 客户端请求超出qps设置时的最大突发请求数。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    c. contentType: application/vnd.kubernetes.protobuf</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定客户端请求的内容类型。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    d. kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - kube-proxy使用的kubeconfig文件路径。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    e. qps: 5</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 每秒向API服务器发送的请求数量。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 4. clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 指定集群使用的CIDR范围，用于自动分配Pod IP。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 5. configSyncPeriod: 15m0s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 指定kube-proxy配置同步到节点的频率。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 6. conntrack:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 连接跟踪设置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    a. max: null</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定连接跟踪的最大值。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    b. maxPerCore: 32768</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定每个核心的最大连接跟踪数。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    c. min: 131072</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定最小的连接跟踪数。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    d. tcpCloseWaitTimeout: 1h0m0s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定处于CLOSE_WAIT状态的TCP连接的超时时间。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    e. tcpEstablishedTimeout: 24h0m0s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#       - 指定已建立的TCP连接的超时时间。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 7. enableProfiling: false</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 是否启用性能分析。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 8. healthzBindAddress: 0.0.0.0:10256</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 指定健康检查监听地址和端口。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 9. hostnameOverride: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#    - 指定覆盖默认主机名的值。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 10. iptables:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - iptables设置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     a. masqueradeAll: false</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 是否对所有流量使用IP伪装。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     b. masqueradeBit: 14</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 指定伪装的Bit标记。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     c. minSyncPeriod: 0s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 指定同步iptables规则的最小间隔。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     d. syncPeriod: 30s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 指定同步iptables规则的时间间隔。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 11. ipvs:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - ipvs设置。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     a. masqueradeAll: true</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 是否对所有流量使用IP伪装。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     b. minSyncPeriod: 5s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 指定同步ipvs规则的最小间隔。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     c. scheduler: &quot;rr&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 指定ipvs默认使用的调度算法。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     d. syncPeriod: 30s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        - 指定同步ipvs规则的时间间隔。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 12. kind: KubeProxyConfiguration</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定该配置文件的类型。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 13. metricsBindAddress: 127.0.0.1:10249</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定指标绑定的地址和端口。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 14. mode: &quot;ipvs&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定kube-proxy的模式。这里指定为ipvs，使用IPVS代理模式。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 15. nodePortAddresses: null</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定可用于NodePort的网络地址。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 16. oomScoreAdj: -999</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定kube-proxy的OOM优先级。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 17. portRange: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定可用于服务端口范围。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 18. udpIdleTimeout: 250ms</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#     - 指定UDP连接的空闲超时时间。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动kube-proxy：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --now</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy.service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启用并立即启动kube-proxy.service单元。kube-proxy.service是kube-proxy守护进程的systemd服务单元。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy.service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 重启kube-proxy.service单元，即重新启动kube-proxy守护进程。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy.service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kube-proxy.service单元的当前状态，包括运行状态、是否启用等信息。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装网络插件" tabindex="-1"><a class="header-anchor" href="#安装网络插件"><span>安装网络插件</span></a></h2><h3 id="准备" tabindex="-1"><a class="header-anchor" href="#准备"><span>准备：</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 官网地址</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">https://github.com/opencontainers/runc/releases</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 升级runc</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># wget https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">install</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -m</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 755</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> runc.amd64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/sbin/runc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/sbin/runc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /usr/local/bin/runc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/sbin/runc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /usr/bin/runc</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#查看当前版本</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@k8s-master-1 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># rpm -qa </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> libseccomp</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">libseccomp-2.5.2-2.el9.x86_64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#下载高于2.4以上的包</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># yum -y install http://rpmfind.net/linux/almalinux/8.10/BaseOS/x86_64/os/Packages/libseccomp-2.5.2-1.el8.x86_64.rpm</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装calico" tabindex="-1"><a class="header-anchor" href="#安装calico"><span>安装Calico</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 更改网段</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://mirrors.chenby.cn/https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico-typha.yaml</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico-typha.yaml</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico-ipv6.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico.yaml</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># calico-config ConfigMap处</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ipam&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;type&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">calico-ipam</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    },</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">autodetect</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CALICO_IPV4POOL_CIDR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">172.16.0.0/12</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IPV6</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico-ipv6.yaml</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># calico-config ConfigMap处</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ipam&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;type&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">calico-ipam</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;assign_ipv4&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">true</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;assign_ipv6&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">true</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    },</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">autodetect</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> IP6</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">autodetect</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CALICO_IPV4POOL_CIDR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">172.16.0.0/12</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CALICO_IPV6POOL_CIDR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fc00:2222::/112</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> FELIX_IPV6SUPPORT</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">true</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 若docker镜像拉不下来，可以使用国内的仓库</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#docker.io/calico/#docker.chenby.cn/calico/#g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#docker.io/calico/#docker.chenby.cn/calico/#g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico-ipv6.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 本地没有公网 IPv6 使用 calico.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> calico.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 本地有公网 IPv6 使用 calico-ipv6.yaml </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># kubectl apply -f calico-ipv6.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看容器状态：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># calico 初始化会很慢 需要耐心等待一下，大约十分钟左右</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@k8s-master01 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># kubectl  get pod -A</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAMESPACE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                       READY</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    RESTARTS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         AGE</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-kube-controllers-7745cdd688-dlpz2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                74s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-node-46pbj</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   55</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (6h52m </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)   7d4h</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-node-7k4k2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   78</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (163m </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)    7d4h</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-node-8nlb5</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   51</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (162m </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)    6h4m</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-node-fk6g6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (88m </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)      99m</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-node-jqsd6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (171m </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)     6h5m</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   calico-typha-bbc4bb7b8-rnh29</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   18</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (6h52m </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)   7d4h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装coredns" tabindex="-1"><a class="header-anchor" href="#安装coredns"><span>安装CoreDNS</span></a></h2><h3 id="安装helm" tabindex="-1"><a class="header-anchor" href="#安装helm"><span>安装helm</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 方式一</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -fsSL</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get_helm.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 700</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get_helm.sh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./get_helm.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 方式二</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://mirrors.huaweicloud.com/helm/v3.13.2/helm-v3.13.2-linux-amd64.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> xvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helm-</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-linux-amd64.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> linux-amd64/helm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>master01上修改配置：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 下载tgz包，网络原因需要多试几次</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">helm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> repo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> add</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://coredns.github.io/helm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">helm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pull</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns/coredns</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> xvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns-</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.tgz</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改IP地址</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> values.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> values.yaml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clusterIP:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">clusterIP:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">10.96.0.10</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 示例</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">---</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># clusterIP: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># clusterIPs: []</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># loadBalancerIP: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># externalIPs: []</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># externalTrafficPolicy: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ipFamilyPolicy: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # The name of the Service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # If not set, a name is generated using the fullname template</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  clusterIP:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">10.96.0.10</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  annotations:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">---</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改为国内源</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#registry.k8s.io/#k8s.chenby.cn/#g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> values.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 默认参数安装</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">helm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./coredns/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改配置文件:</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#10.96.0.10#10.96.0.10#g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CoreDNS/coredns.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">安装coredns</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CoreDNS/coredns.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装最新版coredns" tabindex="-1"><a class="header-anchor" href="#安装最新版coredns"><span>安装最新版CoreDNS</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/coredns/deployment.git</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deployment/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./deploy.sh</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -s</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.96.0.10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> -</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> po</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s-app=kube-dns</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装metricsserver" tabindex="-1"><a class="header-anchor" href="#安装metricsserver"><span>安装<strong><strong>M</strong></strong>etricsServer</span></a></h2><p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。</p><p>安装metrics server</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/k8s-ha-install/metrics-server-0.4.x/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>等待metrics server启动然后查看状态</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  top</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="集群验证" tabindex="-1"><a class="header-anchor" href="#集群验证"><span>集群验证</span></a></h2>`,186)]))}const c=i(k,[["render",h],["__file","index.html.vue"]]),A=JSON.parse(`{"path":"/devops/k8s/base-components/","title":"k8s安装基础组件（二进制方式）","lang":"zh-CN","frontmatter":{"title":"k8s安装基础组件（二进制方式）","createTime":"2025/04/21 22:47:28","permalink":"/devops/k8s/base-components/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;if (um === 'dark' || (um !== 'light' && sm)) {document.documentElement.classList.add('dark');}})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"Containerd安装","slug":"containerd安装","link":"#containerd安装","children":[]},{"level":2,"title":"k8s组件安装","slug":"k8s组件安装","link":"#k8s组件安装","children":[]},{"level":2,"title":"证书生成","slug":"证书生成","link":"#证书生成","children":[{"level":3,"title":"制作etcd证书","slug":"制作etcd证书","link":"#制作etcd证书","children":[]},{"level":3,"title":"制作k8s组件证书","slug":"制作k8s组件证书","link":"#制作k8s组件证书","children":[]}]},{"level":2,"title":"Kubernetes系统组件配置","slug":"kubernetes系统组件配置","link":"#kubernetes系统组件配置","children":[{"level":3,"title":"Etcd配置","slug":"etcd配置","link":"#etcd配置","children":[]}]},{"level":2,"title":"master节点高可用配置","slug":"master节点高可用配置","link":"#master节点高可用配置","children":[{"level":3,"title":"keepalived配置","slug":"keepalived配置","link":"#keepalived配置","children":[]}]},{"level":2,"title":"Kubernetes组件配置","slug":"kubernetes组件配置","link":"#kubernetes组件配置","children":[{"level":3,"title":"Apiserver：","slug":"apiserver","link":"#apiserver","children":[]},{"level":3,"title":"ControllerManager：","slug":"controllermanager","link":"#controllermanager","children":[]},{"level":3,"title":"配置kube-scheduler service：","slug":"配置kube-scheduler-service","link":"#配置kube-scheduler-service","children":[]}]},{"level":2,"title":"TLS Bootstrapping配置","slug":"tls-bootstrapping配置","link":"#tls-bootstrapping配置","children":[{"level":3,"title":"检查当前集群状态：","slug":"检查当前集群状态","link":"#检查当前集群状态","children":[]}]},{"level":2,"title":"Node节点配置","slug":"node节点配置","link":"#node节点配置","children":[{"level":3,"title":"复制证书","slug":"复制证书","link":"#复制证书","children":[]},{"level":3,"title":"Kubelet配置","slug":"kubelet配置","link":"#kubelet配置","children":[]},{"level":3,"title":"kube-proxy配置","slug":"kube-proxy配置","link":"#kube-proxy配置","children":[]}]},{"level":2,"title":"安装网络插件","slug":"安装网络插件","link":"#安装网络插件","children":[{"level":3,"title":"准备：","slug":"准备","link":"#准备","children":[]},{"level":3,"title":"安装Calico","slug":"安装calico","link":"#安装calico","children":[]}]},{"level":2,"title":"安装CoreDNS","slug":"安装coredns","link":"#安装coredns","children":[{"level":3,"title":"安装helm","slug":"安装helm","link":"#安装helm","children":[]},{"level":3,"title":"安装最新版CoreDNS","slug":"安装最新版coredns","link":"#安装最新版coredns","children":[]}]},{"level":2,"title":"安装MetricsServer","slug":"安装metricsserver","link":"#安装metricsserver","children":[]},{"level":2,"title":"集群验证","slug":"集群验证","link":"#集群验证","children":[]}],"readingTime":{"minutes":37.81,"words":11344},"git":{"createdTime":1745249697000,"updatedTime":1751110222000,"contributors":[{"name":"yongjun","email":"1640808365@qq.com","commits":2}]},"filePathRelative":"notes/devops/k8s/k8s安装基础组件（二进制方式）.md"}`);export{c as comp,A as data};
